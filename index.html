<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Login Wallet Solana</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; text-align: center; padding: 2rem; }
    button { padding: 12px 24px; font-size: 16px; background: #00c6ff; color: #000; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #00a8d6; }
    pre { margin-top: 20px; background: #1f1f1f; padding: 15px; border-radius: 6px; max-width: 600px; margin: 1rem auto; text-align: left; }
  </style>
</head>
<body>

<h2>Login dengan Wallet Solana</h2>
<button id="login-btn">Login</button>
<pre id="output"></pre>

<script type="module">
  const BACKEND_URL = "https://game-crypto-backend.onrender.com";
  const loginBtn = document.getElementById("login-btn");
  const output = document.getElementById("output");

  async function login() {
    if (!window.solana?.isPhantom) {
      alert("Phantom Wallet belum terpasang!");
      return;
    }

    try {
      // Connect wallet
      const resp = await window.solana.connect();
      const walletAddress = resp.publicKey.toString();

      // Unique login message
      const message = `Login to Game Crypto\nTimestamp: ${Date.now()}`;
      const encodedMessage = new TextEncoder().encode(message);

      // Sign message
      const signed = await window.solana.signMessage(encodedMessage, 'utf8');
      const signatureArray = Array.from(signed.signature);

      // Send to backend
      const res = await fetch(`${BACKEND_URL}/login-wallet`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet: walletAddress, message, signature: signatureArray }),
      });

      const data = await res.json();
      output.textContent = JSON.stringify(data, null, 2);

      if (data.success) {
        localStorage.setItem("token", data.token);
        localStorage.setItem("user", JSON.stringify(data.user));
        alert("‚úÖ Login berhasil!");
window.location.href = "dompet.html";

        // Optional: call protected endpoint
        const profileRes = await fetch(`${BACKEND_URL}/profile`, {
          headers: { Authorization: `Bearer ${data.token}` }
        });
        const profileData = await profileRes.json();
        console.log("üîí Profile data:", profileData);
      } else {
        alert("Login gagal: " + data.message);
      }

    } catch (err) {
      console.error("‚ùå Error:", err);
      alert("Terjadi kesalahan saat login.");
      output.textContent = err.message;
    }
  }

  loginBtn.addEventListener("click", login);
</script>

</body>
</html>
